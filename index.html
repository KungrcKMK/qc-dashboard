<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Report - Dynamic Trend</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f9ff; }
        .glass-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .gradient-header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
        #root { min-height: 100vh; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 50px; height: 50px; border: 5px solid #cbd5e1; border-top-color: #1e3a8a; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div style="margin-top: 20px; font-weight: bold; color: #1e3a8a;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QC Dashboard...</div>
        </div>
    </div>

    <script type="text/babel">
        // --- 1. Check Libraries ---
        let Recharts = window.Recharts;
        if (!Recharts && window.Recharts && window.Recharts.default) Recharts = window.Recharts.default;
        if (!Recharts) throw new Error("Recharts not found");

        const { LineChart, Line, AreaChart, Area, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = Recharts;
        const { useState, useMemo, useEffect } = React;

        const API_URL = "https://script.google.com/macros/s/AKfycbx94cydYxN1bOSkDVFQlTxVY1QfNKi7AjmYlHOMo9exV9xioIs6vBvlE-GzLUuNY-AY5Q/exec";

        // --- 2. Offline Data ---
        const OFFLINE_DATA = [
            { date: "2026-02-16", time: "11:00", report: "as‡∏ß‡∏∏‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß‡∏Ç‡∏∏‡πà‡∏ô ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡πâ‡∏¢‡∏ô ‡πÅ‡∏Ç‡πá‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞", category: "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏∏‡πâ‡∏ô" },
            { date: "2026-02-15", time: "10:30", report: "as‡πÄ‡∏à‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏° ‡πÄ‡∏´‡∏°‡∏µ‡πà‡∏¢‡∏ß 1 ‡∏™‡πâ‡∏° 3 ‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå 2 ‡∏Ñ‡πà‡∏∞ ‡πÉ‡∏ô‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡∏•", category: "‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏°/‡∏Ç‡∏ô" },
            { date: "2026-02-13", time: "09:00", report: "as‡πÄ‡∏à‡∏≠‡πÄ‡∏®‡∏©‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏∏‡πâ‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å", category: "‡πÅ‡∏Å‡πâ‡∏ß/‡∏Å‡∏£‡∏∞‡∏à‡∏Å" },
            { date: "2026-02-12", time: "15:02", report: "As‡πÅ‡∏°‡∏•‡∏á‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏¢‡∏∏‡πà‡πÉ‡∏ô‡∏ß‡∏∏‡πâ‡∏ô‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡∏Ñ‡∏ô‡∏´‡∏±‡πà‡∏ô‡πÄ‡∏à‡∏≠‡∏Ñ‡πà‡∏∞", category: "‡πÅ‡∏°‡∏•‡∏á/‡∏°‡∏î" },
            { date: "2026-02-12", time: "09:58", report: "As‡∏ú‡∏á‡∏î‡∏≥ ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏•‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏∞", category: "‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏à‡∏∑‡∏≠‡∏õ‡∏ô" },
            { date: "2026-02-12", time: "08:30", report: "‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏î‡∏≥ ‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥‡∏ù‡∏±‡∏á‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡πà‡∏∞", category: "‡∏à‡∏∏‡∏î‡∏î‡∏≥/‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥" },
            { date: "2026-02-11", time: "16:57", report: "as‡πÄ‡∏à‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏° ‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå 2 ‡∏à‡∏∏‡πâ‡∏° 1 ‡πÄ‡∏´‡∏°‡∏µ‡πà‡∏¢‡∏ß 1 ‡∏Ñ‡πà‡∏∞ ‡πÉ‡∏ô‡∏ñ‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡∏•", category: "‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏°/‡∏Ç‡∏ô" },
            { date: "2026-02-11", time: "15:26", report: "As‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏° ‡πÅ‡∏°‡∏•‡∏á ‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥ ‡πÄ‡∏®‡∏©‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ï‡∏¥‡∏î‡∏ß‡∏∏‡πâ‡∏ô‡∏•‡∏≠‡∏ô‡∏ï‡∏≤‡∏•‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", category: "‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" },
            { date: "2026-02-10", time: "12:22", report: "As‡∏Ç‡∏¢‡∏∞‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏™‡∏µ‡∏î‡∏≥ ‡∏ß‡∏∏‡πâ‡∏ô‡∏¢‡∏≤‡∏ß ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏∞", category: "‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏à‡∏∑‡∏≠‡∏õ‡∏ô" },
            { date: "2026-02-05", time: "12:21", report: "As‡πÄ‡∏®‡∏©‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡∏µ‡∏ü‡πâ‡∏≤ ‡∏Ç‡∏ô‡∏ï‡∏≤‡∏ï‡∏¥‡∏î‡∏ß‡∏∏‡πâ‡∏ô‡∏•‡∏≠‡∏ô‡∏ï‡∏≤‡∏•‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°", category: "‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å/‡∏¢‡∏≤‡∏á" },
            { date: "2026-02-04", time: "11:59", report: "as ‡πÄ‡∏à‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏∏‡πâ‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏ô‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏à‡∏≠ ‡∏ß‡∏∏‡πâ‡∏ô‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡∏Ñ‡πà‡∏∞", category: "‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏°/‡∏Ç‡∏ô" },
            { date: "2026-01-25", time: "17:20", report: "As ‡πÄ‡∏à‡∏≠‡∏°‡∏î‡∏≠‡∏¢‡∏∏‡πà‡πÉ‡∏ô‡∏ß‡∏∏‡πâ‡∏ô ‡∏Ñ‡∏∞ ‡∏ß‡∏∏‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏∏‡πà‡∏ô ‡∏Ñ‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏à‡∏≠‡∏Ñ‡∏∞", category: "‡πÅ‡∏°‡∏•‡∏á/‡∏°‡∏î" }
        ];

        const COLORS = ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#6366f1', '#ec4899', '#64748b'];
        const STACK_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#94a3b8'];
        const MONTH_NAMES = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        // --- 3. Parser Logic ---
        const STAFF_NAMES = [
            '‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå', '‡πÄ‡∏´‡∏°‡∏µ‡πà‡∏¢‡∏ß', '‡∏à‡∏∏‡πâ‡∏°', '‡∏™‡πâ‡∏°', '‡∏û‡∏±‡∏í‡∏ô‡πå', '‡πÄ‡∏£‡∏ì‡∏π', '‡πÄ‡∏û‡πá‡∏ç', '‡∏ï‡πà‡∏≤‡∏¢', '‡πÄ‡∏°‡πâ‡∏≤', 
            '‡∏¢‡∏≠‡∏á', '‡∏¢‡∏∏‡∏û‡∏¥‡∏ô', '‡∏™‡∏°‡∏ô‡∏∂‡∏Å', '‡∏ñ‡∏ô‡∏≠‡∏°', '‡∏Å‡πâ‡∏≠‡∏ô', '‡∏ï‡πà‡πä‡∏≠‡∏Å', '‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏á‡∏≠‡∏£', '‡∏•‡∏≠‡∏á', '‡πÄ‡∏¢‡∏≤‡∏ß‡πå', 
            '‡∏ô‡∏ß‡∏•', '‡πÄ‡∏£‡∏µ‡∏¢‡∏°', '‡∏´‡∏•‡∏á', '‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', '‡πÅ‡∏Å‡∏•‡∏∞', '‡∏Å‡πâ‡∏≠‡∏á', '‡∏≠‡∏∏‡∏©‡∏≤', '‡∏ô‡πâ‡∏≠‡∏á', '‡πÅ‡∏ï', '‡∏™‡∏±‡∏ô', '‡∏Ñ‡∏∏‡πâ‡∏°'
        ];

        const parseStaffCounts = (reportText) => {
            let text = reportText.toLowerCase();
            const results = [];
            if (text.includes('‡πÄ‡∏™‡∏µ‡∏¢') || text.includes('‡πÄ‡∏ô‡πà‡∏≤')) return [];
            for (let name of STAFF_NAMES) {
                const regex = new RegExp(`(${name})\\s*[:=]?\\s*(\\d+)?`, 'g');
                let match;
                while ((match = regex.exec(text)) !== null) {
                    let foundName = name;
                    if (foundName === '‡∏û‡∏±‡∏í‡∏ô‡πå') foundName = '‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå';
                    const count = match[2] ? parseInt(match[2]) : 1; 
                    results.push({ name: foundName, count: count });
                    text = text.replace(match[0], ' '); 
                }
            }
            return results;
        };

        const classifyIssue = (text) => {
            if (!text) return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            const t = text.toLowerCase();
            if (t.includes('‡πÅ‡∏Å‡πâ‡∏ß') || t.includes('‡∏Å‡∏£‡∏∞‡∏à‡∏Å') || t.includes('‡πÉ‡∏ö‡∏°‡∏µ‡∏î') || t.includes('‡∏ô‡πá‡∏≠‡∏ï') || t.includes('‡∏ï‡∏∞‡∏õ‡∏π')) return '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (‡πÅ‡∏Å‡πâ‡∏ß/‡πÇ‡∏•‡∏´‡∏∞)';
            if (t.includes('‡πÄ‡∏•‡∏∑‡∏≠‡∏î') || t.includes('‡∏ô‡πâ‡∏≥‡∏•‡∏≤‡∏¢') || t.includes('‡πÄ‡∏•‡πá‡∏ö') || t.includes('‡∏û‡∏•‡∏≤‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå')) return '‡∏™‡∏∏‡∏Ç‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ (‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡πÄ‡∏•‡πá‡∏ö)';
            if (t.includes('‡∏ú‡∏°') || t.includes('‡∏Ç‡∏ô')) return '‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡∏°/‡∏Ç‡∏ô';
            if (t.includes('‡πÅ‡∏°‡∏•‡∏á') || t.includes('‡∏°‡∏î') || t.includes('‡∏´‡∏ô‡∏≠‡∏ô') || t.includes('‡∏¢‡∏∏‡∏á') || t.includes('‡πÅ‡∏°‡∏á') || t.includes('‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏Å')) return '‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏û‡∏≤‡∏´‡∏∞ (‡πÅ‡∏°‡∏•‡∏á/‡∏°‡∏î)';
            if (t.includes('‡∏Ç‡∏∏‡πà‡∏ô') || t.includes('‡πÄ‡∏™‡∏µ‡πâ‡∏¢‡∏ô') || t.includes('‡πÅ‡∏Ç‡πá‡∏á') || t.includes('‡∏î‡πâ‡∏≤‡∏ô')) return '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (‡∏Ç‡∏∏‡πà‡∏ô/‡πÄ‡∏™‡∏µ‡πâ‡∏¢‡∏ô/‡πÅ‡∏Ç‡πá‡∏á)';
            if (t.includes('‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥') || t.includes('‡∏à‡∏∏‡∏î‡∏î‡∏≥') || t.includes('‡∏Ñ‡∏£‡∏≤‡∏ö‡∏î‡∏≥') || t.includes('‡πÄ‡∏®‡∏©‡∏î‡∏≥')) return '‡∏à‡∏∏‡∏î‡∏î‡∏≥/‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥';
            if (t.includes('‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å') || t.includes('‡∏ñ‡∏∏‡∏á') || t.includes('‡∏¢‡∏≤‡∏á') || t.includes('‡∏´‡∏ô‡∏±‡∏á‡∏¢‡∏≤‡∏á')) return '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å/‡∏¢‡∏≤‡∏á';
            if (t.includes('‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å') || t.includes('‡∏ü‡∏≤‡∏á') || t.includes('‡∏õ‡∏≠') || t.includes('‡∏î‡πâ‡∏≤‡∏¢')) return '‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å/‡∏ü‡∏≤‡∏á';
            if (t.includes('‡∏´‡∏¥‡∏ô') || t.includes('‡∏Å‡∏£‡∏ß‡∏î') || t.includes('‡∏ó‡∏£‡∏≤‡∏¢') || t.includes('‡∏î‡∏¥‡∏ô')) return '‡∏î‡∏¥‡∏ô/‡∏´‡∏¥‡∏ô/‡∏ó‡∏£‡∏≤‡∏¢';
            if (t.includes('‡πÑ‡∏°‡πâ') || t.includes('‡∏Å‡πâ‡∏≤‡∏ô') || t.includes('‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å') || t.includes('‡∏Å‡∏≤‡∏Å')) return '‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏û‡∏∑‡∏ä';
            if (t.includes('‡∏î‡∏≥') || t.includes('‡∏ù‡∏∏‡πà‡∏ô') || t.includes('‡∏ú‡∏á')) return '‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏à‡∏∑‡∏≠‡∏õ‡∏ô (‡∏ù‡∏∏‡πà‡∏ô/‡∏ú‡∏á)';
            if (t.includes('‡πÄ‡∏™‡∏µ‡∏¢') || t.includes('‡πÄ‡∏ô‡πà‡∏≤') || t.includes('‡∏ö‡∏π‡∏î')) return 'IGNORE'; 
            return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
        };

        const detectMaterial = (text) => {
            const t = text.toLowerCase();
            if (t.includes('‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡∏•') || t.includes('‡∏ï‡∏≤‡∏•')) return '‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡∏•';
            if (t.includes('‡πÅ‡∏´‡πâ‡∏ß')) return '‡πÅ‡∏´‡πâ‡∏ß';
            if (t.includes('‡∏ß‡∏∏‡πâ‡∏ô')) return '‡∏ß‡∏∏‡πâ‡∏ô';
            if (t.includes('‡∏•‡∏≥‡πÑ‡∏¢') || t.includes('‡∏•‡∏≥‡πÉ‡∏¢')) return '‡∏•‡∏≥‡πÑ‡∏¢';
            if (t.includes('‡πÅ‡∏°‡∏á‡∏•‡∏±‡∏Å')) return '‡πÅ‡∏°‡∏á‡∏•‡∏±‡∏Å';
            if (t.includes('‡∏•‡∏π‡∏Å‡∏•‡∏≤‡∏ô') || t.includes('‡∏•‡∏≤‡∏ô')) return '‡∏•‡∏π‡∏Å‡∏•‡∏≤‡∏ô';
            if (t.includes('‡∏£‡∏ß‡∏°‡∏°‡∏¥‡∏ï‡∏£')) return '‡∏£‡∏ß‡∏°‡∏°‡∏¥‡∏ï‡∏£';
            if (t.includes('‡∏°‡∏±‡∏ô')) return '‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°';
            return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ/‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        };

        const detectProcess = (text) => {
            const t = text.toLowerCase();
            if (t.includes('‡∏•‡πâ‡∏≤‡∏á')) return '‡∏•‡πâ‡∏≤‡∏á';
            if (t.includes('‡∏ï‡∏±‡∏Å')) return '‡∏ï‡∏±‡∏Å/‡∏ö‡∏£‡∏£‡∏à‡∏∏';
            if (t.includes('‡∏Ñ‡∏±‡∏î')) return '‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å';
            if (t.includes('‡∏´‡∏±‡πà‡∏ô') || t.includes('‡∏ú‡πà‡∏≤')) return '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°(‡∏´‡∏±‡πà‡∏ô/‡∏ú‡πà‡∏≤)';
            if (t.includes('‡πÉ‡∏™‡πà') || t.includes('‡∏Å‡∏£‡∏≠‡∏Å')) return '‡πÉ‡∏™‡πà/‡πÄ‡∏ï‡∏¥‡∏°';
            if (t.includes('‡πÄ‡∏Ñ‡∏≤‡∏∞')) return '‡πÄ‡∏Ñ‡∏≤‡∏∞';
            if (t.includes('‡∏ï‡πâ‡∏°') || t.includes('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°')) return '‡∏ï‡πâ‡∏°/‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°';
            if (t.includes('‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏•‡∏ô‡πå') || t.includes('‡∏ã‡∏µ‡∏•') || t.includes('‡∏ï‡∏£‡∏ß‡∏à') || t.includes('qc')) return 'QC/‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏•‡∏ô‡πå';
            return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        };

        const detectSupplier = (text) => {
            const t = text.toLowerCase();
            if (t.includes('‡∏ô‡∏∏‡πà‡∏ô')) return '‡∏ß‡∏∏‡πâ‡∏ô‡∏ô‡∏∏‡πà‡∏ô';
            if (t.includes('‡∏ì‡∏£‡∏á‡∏Ñ‡πå')) return '‡∏ß‡∏∏‡πâ‡∏ô‡∏ì‡∏£‡∏á‡∏Ñ‡πå';
            if (t.includes('‡πÄ‡∏•‡πá‡∏Å')) return '‡∏ß‡∏∏‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å';
            if (t.includes('‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå')) return '‡∏ß‡∏∏‡πâ‡∏ô‡∏≠‡∏≤‡∏£‡∏µ‡∏¢‡πå';
            if (t.includes('‡∏≠‡∏¥‡∏ô‡πÇ‡∏î')) return '‡∏ß‡∏∏‡πâ‡∏ô‡∏≠‡∏¥‡∏ô‡πÇ‡∏î';
            if (t.includes('‡∏´‡∏•‡∏¥‡∏ô')) return '‡∏ß‡∏∏‡πâ‡∏ô‡∏´‡∏•‡∏¥‡∏ô';
            if (t.includes('‡∏ó‡∏π‡πÄ‡∏Ñ')) return '‡∏ß‡∏∏‡πâ‡∏ô‡∏ó‡∏π‡πÄ‡∏Ñ';
            if (t.includes('cnn')) return '‡∏ñ‡∏∏‡∏á CNN';
            if (t.includes('‡πÄ‡∏Å‡∏©‡∏°')) return '‡∏•‡∏π‡∏Å‡∏•‡∏≤‡∏ô‡πÄ‡∏Å‡∏©‡∏°';
            return '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
        };

        // --- 4. Main Component ---
        const App = () => {
            const [rawData, setRawData] = useState(OFFLINE_DATA);
            const [processedData, setProcessedData] = useState([]);
            const [status, setStatus] = useState('offline');

            const [viewMode, setViewMode] = useState('yearly');
            const [selectedDate, setSelectedDate] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
            const [selectedWeek, setSelectedWeek] = useState('');

            const processData = (sourceData) => {
                let processed = [];
                sourceData.forEach((item, originalIdx) => {
                    const category = classifyIssue(item.report);
                    if (category === 'IGNORE') return; 

                    const staffFound = parseStaffCounts(item.report);
                    const material = detectMaterial(item.report); 
                    const process = detectProcess(item.report);
                    const hour = parseInt(item.time.split(':')[0]); 
                    
                    const dateObj = new Date(item.date);
                    const weekNum = !isNaN(dateObj) ? getWeekNumber(dateObj) : 0;
                    const weekStr = `W${String(weekNum).padStart(2, '0')}`;
                    const monthIdx = !isNaN(dateObj) ? dateObj.getMonth() + 1 : 0;
                    const yearStr = !isNaN(dateObj) ? dateObj.getFullYear().toString() : '';

                    const commonData = {
                        ...item,
                        category, material, process, hour, 
                        week: weekStr, month: monthIdx, year: yearStr
                    };

                    if (staffFound.length > 0) {
                        staffFound.forEach((staff, i) => {
                            processed.push({
                                ...commonData,
                                id: `${originalIdx}-${staff.name}-${i}`,
                                sourceName: `‡∏Ñ‡∏∏‡∏ì${staff.name}`,
                                sourceType: 'Staff',
                                count: staff.count
                            });
                        });
                    } else {
                        const supplierName = detectSupplier(item.report);
                        const isSupplier = supplierName !== '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                        processed.push({
                            ...commonData,
                            id: originalIdx,
                            sourceName: isSupplier ? `Supplier: ${supplierName}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                            sourceType: isSupplier ? 'Supplier' : 'Unknown',
                            count: 1
                        });
                    }
                });
                return processed;
            };

            const getRowSummary = (report) => {
                const category = classifyIssue(report);
                if (category === 'IGNORE') return null;
                const staffFound = parseStaffCounts(report);
                if (staffFound.length > 0) {
                    const totalCount = staffFound.reduce((sum, s) => sum + s.count, 0);
                    const breakdown = staffFound.map(s => `${s.name}(${s.count})`).join(", ");
                    return { totalCount, displaySource: breakdown, isStaff: true };
                } else {
                    return { totalCount: 1, displaySource: detectSupplier(report) !== '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' ? detectSupplier(report) : detectProcess(report), isStaff: false };
                }
            };

            useEffect(() => {
                setProcessedData(processData(OFFLINE_DATA));
                fetch(API_URL)
                    .then(res => res.json())
                    .then(json => {
                        if (Array.isArray(json) && json.length > 0) {
                            setRawData(json);
                            setProcessedData(processData(json));
                            setStatus('online');
                            if (json.length > 0) {
                                setSelectedDate(json[0].date); 
                                const d = new Date(json[0].date);
                                if (!isNaN(d)) {
                                    setSelectedYear(d.getFullYear().toString());
                                    const w = getWeekNumber(d);
                                    setSelectedWeek(`W${String(w).padStart(2,'0')}`);
                                }
                            }
                        }
                    })
                    .catch(err => console.log("Online fetch failed"));
            }, []);

            const stats = useMemo(() => {
                // 1. Logic to Filter Data
                const filtered = processedData.filter(d => {
                    if (viewMode === 'daily') {
                        return d.date === selectedDate;
                    } else if (viewMode === 'weekly') {
                        return d.week === selectedWeek && d.year === selectedYear;
                    } else if (viewMode === 'monthly') {
                        return d.month === parseInt(selectedMonth) && d.year === selectedYear;
                    } else if (viewMode === 'yearly') {
                        return d.year === selectedYear;
                    }
                    return true;
                });

                // 2. Dropdown Lists
                const years = {};
                const weeks = {};
                processedData.forEach(d => { 
                    if(d.year) years[d.year] = true; 
                    if(d.week) weeks[d.week] = true;
                });
                const yearsList = Object.keys(years).sort((a,b) => b-a);
                const weeksList = Object.keys(weeks).sort((a,b) => b.localeCompare(a));

                // 3. Stats Calculation
                const total = filtered.reduce((sum, item) => sum + item.count, 0);
                
                const filterUnknown = (dataArr) => {
                    const valid = [];
                    const invalid = [];
                    dataArr.forEach(d => {
                        if (d.name.includes('‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') || d.name.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') || d.name === '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ') {
                            invalid.push(d);
                        } else {
                            valid.push(d);
                        }
                    });
                    const invalidTotal = invalid.reduce((sum, i) => sum + i.value, 0);
                    return { valid, invalidTotal };
                };

                const sourceCounts = {};
                filtered.forEach(d => sourceCounts[d.sourceName] = (sourceCounts[d.sourceName] || 0) + d.count);
                const sourceAll = Object.entries(sourceCounts).map(([name, value]) => ({ name, value })).sort((a,b) => b.value - a.value);
                const { valid: sourceData, invalidTotal: sourceUnknown } = filterUnknown(sourceAll);

                const matCounts = {};
                filtered.forEach(d => matCounts[d.material] = (matCounts[d.material] || 0) + d.count);
                const matAll = Object.entries(matCounts).map(([name, value]) => ({ name, value })).sort((a,b) => b.value - a.value);
                const { valid: materialData, invalidTotal: materialUnknown } = filterUnknown(matAll);

                const procCounts = {};
                filtered.forEach(d => procCounts[d.process] = (procCounts[d.process] || 0) + d.count);
                const procAll = Object.entries(procCounts).map(([name, value]) => ({ name, value })).sort((a,b) => b.value - a.value);
                const { valid: processData, invalidTotal: processUnknown } = filterUnknown(procAll);

                const catCounts = {};
                filtered.forEach(d => catCounts[d.category] = (catCounts[d.category] || 0) + d.count);
                const categoryData = Object.entries(catCounts).map(([name, value]) => ({ name, value })).sort((a,b) => b.value - a.value);

                // --- 4. DYNAMIC TREND LOGIC ---
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -> ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü Hourly
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -> ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü Daily
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏õ‡∏µ -> ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü Monthly
                
                let dynamicTrendData = [];
                let trendTitle = "";

                if (viewMode === 'daily') {
                    trendTitle = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hourly Trend: ${selectedDate})`;
                    const hours = Array(24).fill(0);
                    filtered.forEach(d => hours[d.hour] += d.count);
                    dynamicTrendData = hours.map((val, h) => ({ name: `${h}:00`, value: val }));
                } 
                else if (viewMode === 'weekly' || viewMode === 'monthly') {
                    trendTitle = viewMode === 'weekly' ? `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily Trend: ${selectedWeek})` : `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily Trend: ${MONTH_NAMES[selectedMonth-1]})`;
                    // Group by Date
                    const dailyMap = {};
                    filtered.forEach(d => dailyMap[d.date] = (dailyMap[d.date] || 0) + d.count);
                    dynamicTrendData = Object.entries(dailyMap)
                        .map(([k, v]) => ({ name: k.split('-').slice(1).join('/'), value: v, rawDate: k })) // Show MM/DD
                        .sort((a,b) => a.rawDate.localeCompare(b.rawDate));
                } 
                else { // yearly
                    trendTitle = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly Trend: ${selectedYear})`;
                    const monthMap = {};
                    filtered.forEach(d => monthMap[d.month] = (monthMap[d.month] || 0) + d.count);
                    dynamicTrendData = MONTH_NAMES.map((m, i) => ({ name: m, value: monthMap[i+1] || 0 }));
                }

                // Stacked Charts logic remains similar but uses filtered data context
                const topStaff = sourceAll.slice(0, 5).map(d => d.name);
                const weeklyStaffMap = {};
                const topMats = matAll.slice(0, 5).map(d => d.name);
                const weeklyMatMap = {};

                // Use filtered data for stacked bars to show composition of CURRENT view
                // Group key depends on viewMode
                filtered.forEach(d => {
                    let key = "";
                    if (viewMode === 'daily') key = `${d.hour}:00`;
                    else if (viewMode === 'weekly' || viewMode === 'monthly') key = d.date.split('-').slice(1).join('/');
                    else key = MONTH_NAMES[d.month - 1];

                    if (!weeklyStaffMap[key]) weeklyStaffMap[key] = { name: key, Others: 0, sortKey: d.date || d.month };
                    if (!weeklyMatMap[key]) weeklyMatMap[key] = { name: key, Others: 0, sortKey: d.date || d.month };

                    if (topStaff.includes(d.sourceName)) {
                        weeklyStaffMap[key][d.sourceName] = (weeklyStaffMap[key][d.sourceName] || 0) + d.count;
                    } else {
                        weeklyStaffMap[key]['Others'] += d.count;
                    }

                    if (topMats.includes(d.material)) {
                        weeklyMatMap[key][d.material] = (weeklyMatMap[key][d.material] || 0) + d.count;
                    } else {
                        weeklyMatMap[key]['Others'] += d.count;
                    }
                });

                // Helper to sort dynamic keys
                const sorter = (a, b) => {
                    if (viewMode === 'daily') return parseInt(a.name) - parseInt(b.name);
                    if (viewMode === 'yearly') return MONTH_NAMES.indexOf(a.name) - MONTH_NAMES.indexOf(b.name);
                    return a.name.localeCompare(b.name);
                };

                const weeklyStaffStack = Object.values(weeklyStaffMap).sort(sorter);
                const weeklyMatStack = Object.values(weeklyMatMap).sort(sorter);

                let titleText = "";
                if (viewMode === 'daily') titleText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}`;
                else if (viewMode === 'weekly') titleText = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${selectedWeek} (${selectedYear})`;
                else if (viewMode === 'monthly') titleText = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${MONTH_NAMES[selectedMonth-1]} (${selectedYear})`;
                else titleText = `‡∏õ‡∏µ ${selectedYear}`;

                return { 
                    total, sourceData, sourceUnknown, materialData, materialUnknown, processData, processUnknown, categoryData, 
                    weeklyStaffStack, weeklyMatStack, topStaff, topMats, dynamicTrendData, trendTitle,
                    yearsList, weeksList, titleText
                };
            }, [processedData, viewMode, selectedDate, selectedMonth, selectedYear, selectedWeek]);

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <div className="gradient-header p-6 shadow-lg mb-8">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-3xl font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                    QC Inspection Report
                                </h1>
                                <p className="text-blue-100 text-sm mt-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏° (Real-time)</p>
                            </div>
                            
                            <div className="flex gap-2 items-end bg-white/10 p-3 rounded-xl border border-white/20 backdrop-blur-md">
                                <div className="flex flex-col">
                                    <label className="text-xs text-blue-100 font-bold mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                                    <select className="bg-white text-slate-900 font-bold text-sm rounded px-3 py-1.5 outline-none border-0 shadow-sm w-32"
                                            value={viewMode} onChange={(e) => setViewMode(e.target.value)}>
                                        <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                                        <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                        <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                        <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                                    </select>
                                </div>

                                {viewMode === 'daily' && (
                                    <div className="flex flex-col">
                                        <label className="text-xs text-blue-100 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                        <input type="date" className="bg-white text-slate-800 text-sm rounded px-3 py-1.5 outline-none shadow-sm"
                                            value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} />
                                    </div>
                                )}

                                {(viewMode === 'weekly') && (
                                    <>
                                        <div className="flex flex-col">
                                            <label className="text-xs text-blue-100 mb-1">‡∏õ‡∏µ</label>
                                            <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5 outline-none shadow-sm"
                                                    value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>
                                                {stats.yearsList.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex flex-col">
                                            <label className="text-xs text-blue-100 mb-1">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
                                            <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5 outline-none shadow-sm"
                                                    value={selectedWeek} onChange={(e) => setSelectedWeek(e.target.value)}>
                                                {stats.weeksList.map(w => <option key={w} value={w}>{w}</option>)}
                                            </select>
                                        </div>
                                    </>
                                )}

                                {(viewMode === 'monthly') && (
                                    <>
                                        <div className="flex flex-col">
                                            <label className="text-xs text-blue-100 mb-1">‡∏õ‡∏µ</label>
                                            <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5 outline-none shadow-sm"
                                                    value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>
                                                {stats.yearsList.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                        </div>
                                        <div className="flex flex-col">
                                            <label className="text-xs text-blue-100 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                            <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5 outline-none shadow-sm"
                                                    value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))}>
                                                {MONTH_NAMES.map((m, i) => <option key={i} value={i+1}>{m}</option>)}
                                            </select>
                                        </div>
                                    </>
                                )}

                                {viewMode === 'yearly' && (
                                    <div className="flex flex-col">
                                        <label className="text-xs text-blue-100 mb-1">‡∏õ‡∏µ</label>
                                        <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5 outline-none shadow-sm"
                                                value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>
                                            <option value="All">All Years</option>
                                            {stats.yearsList.map(y => <option key={y} value={y}>{y}</option>)}
                                        </select>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 space-y-6">
                        
                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="glass-card p-5 border-l-4 border-blue-600">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Total Defects</p>
                                <h3 className="text-3xl font-bold text-slate-800">{stats.total} <span className="text-sm text-slate-400 font-normal">items</span></h3>
                                <p className="text-xs text-blue-500 mt-1 font-medium bg-blue-50 inline-block px-1 rounded">{stats.titleText}</p>
                            </div>
                            <div className="glass-card p-5 border-l-4 border-emerald-500">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Top Material</p>
                                <h3 className="text-xl font-bold text-emerald-600 truncate">{stats.materialData[0]?.name || '-'}</h3>
                                <p className="text-xs text-slate-400">({stats.materialData[0]?.value} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
                            </div>
                            <div className="glass-card p-5 border-l-4 border-indigo-500">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Top Process</p>
                                <h3 className="text-xl font-bold text-indigo-600 truncate">{stats.processData[0]?.name || '-'}</h3>
                                <p className="text-xs text-slate-400">({stats.processData[0]?.value} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
                            </div>
                            <div className="glass-card p-5 border-l-4 border-red-500">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Focus Person</p>
                                <h3 className="text-xl font-bold text-red-600 truncate">{stats.sourceData[0]?.name || '-'}</h3>
                                <p className="text-xs text-slate-400">({stats.sourceData[0]?.value} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
                            </div>
                        </div>

                        {/* DYNAMIC TREND CHART */}
                        <div className="glass-card p-6">
                            <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                                {stats.trendTitle}
                            </h3>
                            <div style={{ height: 300 }}>
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={stats.dynamicTrendData} margin={{ top: 10, right: 30, left: 10, bottom: 0 }}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                        <XAxis dataKey="name" tick={{fontSize: 12, fill: '#64748b'}} />
                                        <YAxis tick={{fontSize: 12, fill: '#64748b'}} allowDecimals={false} />
                                        <Tooltip cursor={{stroke: '#94a3b8', strokeWidth: 1, strokeDasharray: '3 3'}} />
                                        <Line type="monotone" dataKey="value" stroke="#3b82f6" strokeWidth={3} dot={{ r: 4, fill: '#3b82f6', strokeWidth: 2, stroke: '#fff' }} activeDot={{ r: 6 }} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* STACKED TREND CHARTS (Dynamic based on filter) */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                    Composition: ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Top 5)
                                </h3>
                                <div style={{ height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={stats.weeklyStaffStack} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={{fontSize: 12, fill: '#64748b'}} />
                                            <YAxis tick={{fontSize: 12, fill: '#64748b'}} allowDecimals={false} />
                                            <Tooltip cursor={{fill: '#f1f5f9'}} />
                                            <Legend wrapperStyle={{fontSize: '11px', paddingTop: '10px'}} />
                                            {stats.topStaff.map((name, idx) => (
                                                <Bar key={name} dataKey={name} stackId="a" fill={STACK_COLORS[idx % STACK_COLORS.length]} />
                                            ))}
                                            <Bar dataKey="Others" stackId="a" fill="#cbd5e1" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                    Composition: ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Top 5)
                                </h3>
                                <div style={{ height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={stats.weeklyMatStack} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={{fontSize: 12, fill: '#64748b'}} />
                                            <YAxis tick={{fontSize: 12, fill: '#64748b'}} allowDecimals={false} />
                                            <Tooltip cursor={{fill: '#f1f5f9'}} />
                                            <Legend wrapperStyle={{fontSize: '11px', paddingTop: '10px'}} />
                                            {stats.topMats.map((name, idx) => (
                                                <Bar key={name} dataKey={name} stackId="a" fill={STACK_COLORS[idx % STACK_COLORS.length]} />
                                            ))}
                                            <Bar dataKey="Others" stackId="a" fill="#cbd5e1" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Chart Row 1: Material & Process (FILTERED) */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">üì¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Top 10) <span className="text-sm font-normal text-blue-500 ml-2">[{stats.titleText}]</span></h3>
                                <div style={{ height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={stats.materialData.slice(0,10)} layout="vertical" margin={{ left: 20 }}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12, fill: '#64748b'}} />
                                            <Tooltip cursor={{fill: '#f1f5f9'}} />
                                            <Bar dataKey="value" fill="#10b981" radius={[0,4,4,0]} barSize={20} label={{ position: 'right', fontSize: 11, fill: '#666' }} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">‚öôÔ∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (Top 10) <span className="text-sm font-normal text-blue-500 ml-2">[{stats.titleText}]</span></h3>
                                <div style={{ height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={stats.processData.slice(0,10)} layout="vertical" margin={{ left: 20 }}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12, fill: '#64748b'}} />
                                            <Tooltip cursor={{fill: '#f1f5f9'}} />
                                            <Bar dataKey="value" fill="#6366f1" radius={[0,4,4,0]} barSize={20} label={{ position: 'right', fontSize: 11, fill: '#666' }} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Chart Row 2: Pie & Source (FILTERED) */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">üç∞ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤ <span className="text-sm font-normal text-blue-500 ml-2">[{stats.titleText}]</span></h3>
                                <div style={{ height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie 
                                                data={stats.categoryData} 
                                                dataKey="value" 
                                                nameKey="name" 
                                                cx="50%" 
                                                cy="50%" 
                                                outerRadius={80} 
                                                innerRadius={40}
                                                paddingAngle={2}
                                                label={({ name, percent }) => percent === 0 ? null : `${(percent * 100).toFixed(0)}%`}
                                                labelLine={true}
                                                style={{ fontSize: '11px' }}
                                            >
                                                {stats.categoryData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                ))}
                                            </Pie>
                                            <Tooltip contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                            <Legend layout="horizontal" verticalAlign="bottom" align="center" wrapperStyle={{fontSize: '11px', paddingTop: '10px'}} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">üèÜ Top 10 ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö <span className="text-sm font-normal text-blue-500 ml-2">[{stats.titleText}]</span></h3>
                                <div style={{ height: 300 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={stats.sourceData.slice(0,10)} layout="vertical" margin={{ left: 10 }}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 11, fill: '#64748b'}} />
                                            <Tooltip cursor={{fill: '#f1f5f9'}} />
                                            <Bar dataKey="value" fill="#ef4444" radius={[0,4,4,0]} barSize={15} label={{ position: 'right', fontSize: 11, fill: '#666' }} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Data Table */}
                        <div className="glass-card overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Latest Entries)</span>
                                <span className="text-xs text-gray-400">Filtered by: {stats.titleText}</span>
                            </div>
                            <div className="overflow-x-auto max-h-[400px]">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="bg-white sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Date/Time</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Week</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Material</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Process</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Source</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold w-1/3">Raw Report</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold text-center">Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 bg-white">
                                        {processedData
                                            .filter(d => {
                                                if (viewMode === 'daily') return d.date === selectedDate;
                                                if (viewMode === 'weekly') return d.week === selectedWeek && d.year === selectedYear;
                                                if (viewMode === 'monthly') return d.month === parseInt(selectedMonth) && d.year === selectedYear;
                                                if (viewMode === 'yearly') return d.year === selectedYear;
                                                return true;
                                            })
                                            .map((item, idx) => {
                                                const summary = getRowSummary(item.report);
                                                if(!summary) return null;
                                                const prod = detectMaterial(item.report);
                                                const proc = detectProcess(item.report);
                                                
                                                return (
                                                    <tr key={idx} className="hover:bg-blue-50 transition">
                                                        <td className="px-6 py-3 whitespace-nowrap">
                                                            <div className="font-medium text-slate-700">{item.date}</div>
                                                            <div className="text-xs text-blue-400">{item.time}</div>
                                                        </td>
                                                        <td className="px-6 py-3 text-xs text-slate-500 font-bold">{item.week}</td>
                                                        <td className="px-6 py-3"><span className={`px-2 py-1 rounded-full text-xs font-medium ${prod.includes('‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') ? 'text-gray-400 border border-gray-200' : 'bg-emerald-100 text-emerald-700'}`}>{prod}</span></td>
                                                        <td className="px-6 py-3"><span className={`px-2 py-1 rounded-full text-xs font-medium ${proc.includes('‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') ? 'text-gray-400 border border-gray-200' : 'bg-indigo-100 text-indigo-700'}`}>{proc}</span></td>
                                                        <td className="px-6 py-3 text-blue-600 font-medium">{summary.displaySource}</td>
                                                        <td className="px-6 py-3 text-xs text-slate-500">{item.report}</td>
                                                        <td className="px-6 py-3 text-center font-bold text-slate-800">{summary.totalCount}</td>
                                                    </tr>
                                                );
                                            })
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
