<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Report - Dynamic Master Data</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f9ff; }
        .glass-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .gradient-header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
        #root { min-height: 100vh; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: white !important; }
            .no-print { display: none !important; }
            .glass-card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; break-inside: avoid; margin-bottom: 20px; }
            .gradient-header { background: #1e3a8a !important; -webkit-print-color-adjust: exact; color: white !important; padding: 10px; border-radius: 8px;}
            .print-grid { display: grid; grid-template-columns: repeat(2, 1fr) !important; gap: 10px; }
            .recharts-responsive-container { width: 100% !important; height: 250px !important; }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <div style="width: 50px; height: 50px; border: 5px solid #cbd5e1; border-top-color: #1e3a8a; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div style="margin-top: 20px; font-weight: bold; color: #1e3a8a;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Master Data...</div>
        </div>
    </div>

    <script type="text/babel">
        let Recharts = window.Recharts;
        if (!Recharts && window.Recharts && window.Recharts.default) Recharts = window.Recharts.default;
        
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = Recharts;
        const { useState, useMemo, useEffect } = React;

        // ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const API_URL = "https://script.google.com/macros/s/AKfycbx94cydYxN1bOSkDVFQlTxVY1QfNKi7AjmYlHOMo9exV9xioIs6vBvlE-GzLUuNY-AY5Q/exec";

        // ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
        const COLORS = ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#6366f1', '#ec4899', '#64748b'];
        const STACK_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#94a3b8'];
        const MONTH_NAMES = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        }

        // ==========================================
        // DYNAMIC PARSER ENGINE (‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ MasterData)
        // ==========================================
        
        const parseStaffCountsDynamic = (reportText, staffList) => {
            let text = reportText.toLowerCase();
            const results = [];
            if (text.includes('‡πÄ‡∏™‡∏µ‡∏¢') || text.includes('‡πÄ‡∏ô‡πà‡∏≤')) return [];
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏™‡∏°‡∏ä‡∏≤‡∏¢" ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô "‡∏™‡∏°"
            const sortedStaff = [...staffList].sort((a, b) => b.length - a.length);

            for (let name of sortedStaff) {
                if(!name) continue;
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                const regex = new RegExp(`(${name.toLowerCase()})\\s*[:=]?\\s*(\\d+)?`, 'g');
                let match;
                while ((match = regex.exec(text)) !== null) {
                    const count = match[2] ? parseInt(match[2]) : 1; 
                    results.push({ name: name, count: count });
                    text = text.replace(match[0], ' '); // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å
                }
            }
            return results;
        };

        const findKeywordInList = (text, keywordList, defaultVal = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏") => {
            const t = text.toLowerCase();
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡∏à‡∏≤‡∏Å‡∏¢‡∏≤‡∏ß‡πÑ‡∏õ‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
            const sortedList = [...keywordList].sort((a,b) => b.length - a.length);
            for (let word of sortedList) {
                if(!word) continue;
                if (t.includes(word.toLowerCase())) return word;
            }
            return defaultVal;
        };

        // ==========================================
        // MAIN APP COMPONENT
        // ==========================================
        const App = () => {
            const [rawData, setRawData] = useState([]);
            const [status, setStatus] = useState('loading');

            // Default Master Data (‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à)
            const [master, setMaster] = useState({
                staff: ['‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå', '‡πÄ‡∏´‡∏°‡∏µ‡πà‡∏¢‡∏ß', '‡∏à‡∏∏‡πâ‡∏°', '‡∏™‡πâ‡∏°', '‡∏û‡∏±‡∏í‡∏ô‡πå'],
                supplier: ['‡∏ô‡∏∏‡πà‡∏ô', '‡∏ì‡∏£‡∏á‡∏Ñ‡πå', '‡πÄ‡∏•‡πá‡∏Å'],
                material: ['‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡∏•', '‡πÅ‡∏´‡πâ‡∏ß', '‡∏ß‡∏∏‡πâ‡∏ô', '‡∏•‡∏≥‡πÑ‡∏¢'],
                process: ['‡∏•‡πâ‡∏≤‡∏á', '‡∏ï‡∏±‡∏Å', '‡∏Ñ‡∏±‡∏î', '‡∏´‡∏±‡πà‡∏ô'],
                defect: ['‡πÅ‡∏Å‡πâ‡∏ß', '‡∏ú‡∏°', '‡πÅ‡∏°‡∏•‡∏á', '‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥', '‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å']
            });

            // UI States
            const [viewMode, setViewMode] = useState('yearly');
            const [selectedDate, setSelectedDate] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedYear, setSelectedYear] = useState('All');
            const [selectedWeek, setSelectedWeek] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');

            // Data Fetching
            useEffect(() => {
                fetch(API_URL)
                    .then(res => res.json())
                    .then(json => {
                        // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á { data: [], masterData: {} }
                        if (json.data && json.masterData) {
                            setMaster(json.masterData);
                            setRawData(json.data);
                            setStatus('online');
                            
                            if (json.data.length > 0) {
                                setSelectedDate(json.data[0].date); 
                                const d = new Date(json.data[0].date);
                                if (!isNaN(d)) setSelectedWeek(`W${String(getWeekNumber(d)).padStart(2,'0')}`);
                            }
                        } else if (Array.isArray(json)) {
                            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö API ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                            setRawData(json);
                            setStatus('online');
                        }
                    })
                    .catch(err => {
                        console.log("Fetch failed", err);
                        setStatus('error');
                    });
            }, []);

            // 1. ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Raw) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (Processed)
            const processedData = useMemo(() => {
                let processed = [];
                rawData.forEach((item, originalIdx) => {
                    const text = item.report || "";
                    
                    // ‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å Master Data
                    let category = findKeywordInList(text, master.defect, "‡∏≠‡∏∑‡πà‡∏ô‡πÜ");
                    if (text.toLowerCase().includes('‡πÄ‡∏™‡∏µ‡∏¢') || text.toLowerCase().includes('‡πÄ‡∏ô‡πà‡∏≤')) category = 'IGNORE';
                    if (category === 'IGNORE') return; 

                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Master Data
                    const staffFound = parseStaffCountsDynamic(text, master.staff);
                    const material = findKeywordInList(text, master.material);
                    const process = findKeywordInList(text, master.process);
                    const supplierName = findKeywordInList(text, master.supplier, "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ");
                    
                    const timeStr = item.time || "00:00";
                    const hour = parseInt(timeStr.split(':')[0]) || 0; 
                    
                    const dateObj = new Date(item.date);
                    const weekStr = !isNaN(dateObj) ? `W${String(getWeekNumber(dateObj)).padStart(2, '0')}` : '-';
                    const monthIdx = !isNaN(dateObj) ? dateObj.getMonth() + 1 : 0;
                    const yearStr = !isNaN(dateObj) ? dateObj.getFullYear().toString() : '';

                    const baseData = { ...item, category, material, process, hour, week: weekStr, month: monthIdx, year: yearStr };

                    if (staffFound.length > 0) {
                        staffFound.forEach((staff, i) => {
                            processed.push({ ...baseData, id: `${originalIdx}-S-${i}`, sourceName: `‡∏Ñ‡∏∏‡∏ì${staff.name}`, count: staff.count });
                        });
                    } else {
                        processed.push({ ...baseData, id: `${originalIdx}-U`, sourceName: supplierName !== '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' ? `Supplier: ${supplierName}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', count: 1 });
                    }
                });
                return processed;
            }, [rawData, master]);

            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Table Summary
            const getRowSummary = (reportText) => {
                const text = reportText || "";
                if (text.toLowerCase().includes('‡πÄ‡∏™‡∏µ‡∏¢') || text.toLowerCase().includes('‡πÄ‡∏ô‡πà‡∏≤')) return null;
                const staffFound = parseStaffCountsDynamic(text, master.staff);
                if (staffFound.length > 0) {
                    return { totalCount: staffFound.reduce((s, x) => s + x.count, 0), display: staffFound.map(s => `${s.name}(${s.count})`).join(", ") };
                } else {
                    const supp = findKeywordInList(text, master.supplier, "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ");
                    const proc = findKeywordInList(text, master.process, "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏");
                    return { totalCount: 1, display: supp !== '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' ? supp : proc };
                }
            };

            // 2. ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const stats = useMemo(() => {
                // Filter
                const filtered = processedData.filter(d => {
                    const matchYear = selectedYear === 'All' || d.year === selectedYear;
                    let timeMatch = true;
                    if (viewMode === 'daily') timeMatch = d.date === selectedDate;
                    else if (viewMode === 'weekly') timeMatch = matchYear && (selectedWeek === 'All' || d.week === selectedWeek);
                    else if (viewMode === 'monthly') timeMatch = matchYear && d.month === parseInt(selectedMonth);
                    else if (viewMode === 'yearly') timeMatch = matchYear;

                    let searchMatch = true;
                    if (searchQuery.trim() !== '') {
                        const q = searchQuery.toLowerCase();
                        searchMatch = (d.report||'').toLowerCase().includes(q) || d.sourceName.toLowerCase().includes(q) || d.material.toLowerCase().includes(q) || d.process.toLowerCase().includes(q) || d.category.toLowerCase().includes(q);
                    }
                    return timeMatch && searchMatch;
                });

                // KPI
                let prevTotal = 0; let kpiChange = null;
                if (viewMode === 'daily' && selectedDate) {
                    const pd = new Date(selectedDate); pd.setDate(pd.getDate() - 1);
                    const prevDateStr = pd.toISOString().split('T')[0];
                    prevTotal = processedData.filter(x => x.date === prevDateStr).reduce((s,x)=>s+x.count,0);
                } else if (viewMode === 'monthly') {
                    let pm = selectedMonth - 1; let py = parseInt(selectedYear);
                    if(pm === 0) { pm = 12; py--; }
                    prevTotal = processedData.filter(x => x.month === pm && x.year === py.toString()).reduce((s,x)=>s+x.count,0);
                } else if (viewMode === 'yearly' && selectedYear !== 'All') {
                    prevTotal = processedData.filter(x => x.year === (parseInt(selectedYear) - 1).toString()).reduce((s,x)=>s+x.count,0);
                } else if (viewMode === 'weekly' && selectedWeek !== 'All') {
                    let pw = parseInt(selectedWeek.replace('W','')) - 1; let py = parseInt(selectedYear);
                    if(pw === 0) { pw = 52; py--; } 
                    prevTotal = processedData.filter(x => x.week === `W${String(pw).padStart(2,'0')}` && x.year === py.toString()).reduce((s,x)=>s+x.count,0);
                }
                const total = filtered.reduce((sum, item) => sum + item.count, 0);
                if (prevTotal > 0) kpiChange = ((total - prevTotal) / prevTotal) * 100;

                // Dropdowns
                const years = {}; const weeks = {};
                processedData.forEach(d => { if(d.year) years[d.year] = true; if(d.week) weeks[d.week] = true; });
                const yearsList = Object.keys(years).sort((a,b) => b-a);
                const weeksList = Object.keys(weeks).sort((a,b) => b.localeCompare(a));

                // Groups
                const agg = (key) => {
                    const counts = {};
                    filtered.forEach(d => counts[d[key]] = (counts[d[key]] || 0) + d.count);
                    return Object.entries(counts).filter(([k]) => !k.includes('‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') && !k.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ')).map(([n, v]) => ({ name: n, value: v })).sort((a,b) => b.value - a.value);
                };
                const sourceData = agg('sourceName');
                const materialData = agg('material');
                const processData = agg('process');
                
                // Category Pie (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
                const catCounts = {}; filtered.forEach(d => catCounts[d.category] = (catCounts[d.category] || 0) + d.count);
                const categoryData = Object.entries(catCounts).map(([n, v]) => ({ name: n, value: v })).sort((a,b) => b.value - a.value);

                // Trend
                let dynamicTrendData = []; let trendTitle = "";
                if (viewMode === 'daily') {
                    trendTitle = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Hourly Trend: ${selectedDate})`;
                    const hours = Array(24).fill(0); filtered.forEach(d => hours[d.hour] += d.count);
                    dynamicTrendData = hours.map((val, h) => ({ name: `${h}:00`, value: val }));
                } else if (viewMode === 'weekly' || viewMode === 'monthly') {
                    trendTitle = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily Trend)`;
                    const dailyMap = {}; filtered.forEach(d => dailyMap[d.date] = (dailyMap[d.date] || 0) + d.count);
                    dynamicTrendData = Object.entries(dailyMap).map(([k, v]) => ({ name: k.split('-').slice(1).join('/'), value: v, rawDate: k })).sort((a,b) => a.rawDate.localeCompare(b.rawDate));
                } else {
                    if (selectedYear === 'All') {
                        trendTitle = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Yearly Trend)`;
                        const yearMap = {}; filtered.forEach(d => yearMap[d.year] = (yearMap[d.year] || 0) + d.count);
                        dynamicTrendData = Object.entries(yearMap).map(([y, v]) => ({ name: y, value: v })).sort((a,b) => a.name.localeCompare(b.name));
                    } else {
                        trendTitle = `‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly Trend: ${selectedYear})`;
                        const monthMap = {}; filtered.forEach(d => monthMap[d.month] = (monthMap[d.month] || 0) + d.count);
                        dynamicTrendData = MONTH_NAMES.map((m, i) => ({ name: m, value: monthMap[i+1] || 0 }));
                    }
                }

                // Stack
                const topStaff = sourceData.slice(0, 5).map(d => d.name); const weeklyStaffMap = {};
                const topMats = materialData.slice(0, 5).map(d => d.name); const weeklyMatMap = {};

                filtered.forEach(d => {
                    let key = "";
                    if (viewMode === 'daily') key = `${d.hour}:00`;
                    else if (viewMode === 'weekly' || viewMode === 'monthly') key = d.date.split('-').slice(1).join('/');
                    else key = selectedYear === 'All' ? d.year : MONTH_NAMES[d.month - 1];

                    if (!weeklyStaffMap[key]) weeklyStaffMap[key] = { name: key, Others: 0 };
                    if (!weeklyMatMap[key]) weeklyMatMap[key] = { name: key, Others: 0 };

                    if (topStaff.includes(d.sourceName)) weeklyStaffMap[key][d.sourceName] = (weeklyStaffMap[key][d.sourceName] || 0) + d.count;
                    else weeklyStaffMap[key]['Others'] += d.count;

                    if (topMats.includes(d.material)) weeklyMatMap[key][d.material] = (weeklyMatMap[key][d.material] || 0) + d.count;
                    else weeklyMatMap[key]['Others'] += d.count;
                });

                const sorter = (a, b) => {
                    if (viewMode === 'daily') return parseInt(a.name) - parseInt(b.name);
                    if (viewMode === 'yearly' && selectedYear !== 'All') return MONTH_NAMES.indexOf(a.name) - MONTH_NAMES.indexOf(b.name);
                    return a.name.localeCompare(b.name); 
                };
                const weeklyStaffStack = Object.values(weeklyStaffMap).sort(sorter);
                const weeklyMatStack = Object.values(weeklyMatMap).sort(sorter);

                let titleText = "";
                if (viewMode === 'daily') titleText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${selectedDate}`;
                else if (viewMode === 'weekly') titleText = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${selectedWeek} (${selectedYear})`;
                else if (viewMode === 'monthly') titleText = `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${MONTH_NAMES[selectedMonth-1]} (${selectedYear})`;
                else titleText = selectedYear === 'All' ? '‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (All Years)' : `‡∏õ‡∏µ ${selectedYear}`;
                if (searchQuery.trim() !== '') titleText += ` [‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${searchQuery}]`;

                return { 
                    total, kpiChange, sourceData, materialData, processData, categoryData, 
                    weeklyStaffStack, weeklyMatStack, topStaff, topMats, dynamicTrendData, trendTitle,
                    yearsList, weeksList, titleText, tableData: filtered
                };
            }, [processedData, viewMode, selectedDate, selectedMonth, selectedYear, selectedWeek, searchQuery]);

            const exportToCSV = () => {
                const header = "Date,Time,Week,Material,Process,Source,Category,Count,Report Details\n";
                const rows = stats.tableData.map(d => `"${d.date}","${d.time}","${d.week}","${d.material}","${d.process}","${d.sourceName}","${d.category}","${d.count}","${(d.report||'').replace(/"/g, '""')}"`).join("\n");
                const blob = new Blob(["\uFEFF" + header + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `QC_Export_${new Date().getTime()}.csv`;
                link.click();
            };

            if (status === 'loading') return <div className="text-center mt-20 text-blue-800 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;

            return (
                <div className="min-h-screen pb-20">
                    <div className="gradient-header p-6 shadow-lg mb-8 no-print">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-3xl font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                    QC Inspection Report
                                </h1>
                                <p className="text-blue-100 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Master Data</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.print()} className="bg-white/20 hover:bg-white/30 text-white border border-white/40 px-3 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition">
                                    Print PDF
                                </button>
                                <button onClick={exportToCSV} className="bg-emerald-500 hover:bg-emerald-600 text-white border border-emerald-400 px-3 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition shadow-md">
                                    Export CSV
                                </button>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="max-w-7xl mx-auto mt-6 flex flex-wrap gap-4 items-end bg-white/10 p-4 rounded-xl border border-white/20">
                            <div className="flex flex-col">
                                <label className="text-xs text-blue-100 font-bold mb-1">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (Smart Search)</label>
                                <input type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô, ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö..." className="bg-white text-slate-800 text-sm rounded-lg px-3 py-1.5 outline-none w-56 focus:ring-2 ring-blue-300"
                                    value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                            </div>
                            <div className="h-8 border-l border-white/20 mx-2"></div>
                            <div className="flex flex-col">
                                <label className="text-xs text-blue-100 font-bold mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                                <select className="bg-white text-slate-900 font-bold text-sm rounded px-3 py-1.5 outline-none w-32" value={viewMode} onChange={(e) => setViewMode(e.target.value)}>
                                    <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                                    <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                    <option value="yearly">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</option>
                                </select>
                            </div>
                            {viewMode === 'daily' && <input type="date" className="bg-white text-slate-800 text-sm rounded px-3 py-1.5" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} />}
                            {viewMode !== 'daily' && (
                                <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5" value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>
                                    <option value="All">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (All Years)</option>
                                    {stats.yearsList.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            )}
                            {viewMode === 'weekly' && (
                                <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5" value={selectedWeek} onChange={(e) => setSelectedWeek(e.target.value)}>
                                    <option value="All">‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                                    {stats.weeksList.map(w => <option key={w} value={w}>{w}</option>)}
                                </select>
                            )}
                            {viewMode === 'monthly' && (
                                <select className="bg-white text-slate-800 text-sm rounded px-3 py-1.5" value={selectedMonth} onChange={(e) => setSelectedMonth(parseInt(e.target.value))}>
                                    {MONTH_NAMES.map((m, i) => <option key={i} value={i+1}>{m}</option>)}
                                </select>
                            )}
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 space-y-6">
                        {/* KPI */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 print-grid">
                            <div className="glass-card p-5 border-l-4 border-blue-600">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Total Defects</p>
                                <h3 className="text-3xl font-bold text-slate-800">{stats.total} <span className="text-sm text-slate-400 font-normal">‡∏ä‡∏¥‡πâ‡∏ô</span></h3>
                                <p className="text-xs text-blue-500 mt-1 font-medium truncate w-full">{stats.titleText}</p>
                                {stats.kpiChange !== null && !isNaN(stats.kpiChange) && (
                                    <div className={`mt-1 text-xs font-bold ${stats.kpiChange > 0 ? 'text-red-500' : 'text-emerald-500'}`}>
                                        {stats.kpiChange > 0 ? '‚ñ≤ ‡πÅ‡∏¢‡πà‡∏•‡∏á' : '‚ñº ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô'} {Math.abs(stats.kpiChange).toFixed(1)}% (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
                                    </div>
                                )}
                            </div>
                            <div className="glass-card p-5 border-l-4 border-emerald-500">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Top Material</p>
                                <h3 className="text-xl font-bold text-emerald-600 truncate">{stats.materialData[0]?.name || '-'}</h3>
                                <p className="text-xs text-slate-400">({stats.materialData[0]?.value || 0} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
                            </div>
                            <div className="glass-card p-5 border-l-4 border-indigo-500">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Top Process</p>
                                <h3 className="text-xl font-bold text-indigo-600 truncate">{stats.processData[0]?.name || '-'}</h3>
                                <p className="text-xs text-slate-400">({stats.processData[0]?.value || 0} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
                            </div>
                            <div className="glass-card p-5 border-l-4 border-red-500">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Focus Person</p>
                                <h3 className="text-xl font-bold text-red-600 truncate">{stats.sourceData[0]?.name || '-'}</h3>
                                <p className="text-xs text-slate-400">({stats.sourceData[0]?.value || 0} ‡∏ä‡∏¥‡πâ‡∏ô)</p>
                            </div>
                        </div>

                        {/* Trend Chart */}
                        <div className="glass-card p-6 break-inside-avoid">
                            <h3 className="text-lg font-bold text-slate-700 mb-4">{stats.trendTitle}</h3>
                            <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                <LineChart data={stats.dynamicTrendData} margin={{ top: 10, right: 30, left: 10, bottom: 0 }}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" tick={{fontSize: 12, fill: '#64748b'}} />
                                    <YAxis tick={{fontSize: 12, fill: '#64748b'}} allowDecimals={false} />
                                    <Tooltip />
                                    <Line type="monotone" dataKey="value" stroke="#3b82f6" strokeWidth={3} dot={{ r: 4, fill: '#3b82f6', strokeWidth: 2, stroke: '#fff' }} />
                                </LineChart>
                            </ResponsiveContainer></div>
                        </div>

                        {/* Stacked Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print-grid break-inside-avoid">
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (Top 5)</h3>
                                <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.weeklyStaffStack}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="name" tick={{fontSize: 11}} />
                                        <YAxis tick={{fontSize: 11}} allowDecimals={false} />
                                        <Tooltip />
                                        <Legend wrapperStyle={{fontSize:'11px'}} />
                                        {stats.topStaff.map((name, i) => <Bar key={name} dataKey={name} stackId="a" fill={STACK_COLORS[i % STACK_COLORS.length]} />)}
                                        <Bar dataKey="Others" stackId="a" fill="#cbd5e1" />
                                    </BarChart>
                                </ResponsiveContainer></div>
                            </div>
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (Top 5)</h3>
                                <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.weeklyMatStack}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="name" tick={{fontSize: 11}} />
                                        <YAxis tick={{fontSize: 11}} allowDecimals={false} />
                                        <Tooltip />
                                        <Legend wrapperStyle={{fontSize:'11px'}} />
                                        {stats.topMats.map((name, i) => <Bar key={name} dataKey={name} stackId="a" fill={STACK_COLORS[i % STACK_COLORS.length]} />)}
                                        <Bar dataKey="Others" stackId="a" fill="#cbd5e1" />
                                    </BarChart>
                                </ResponsiveContainer></div>
                            </div>
                        </div>

                        {/* Bar Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print-grid break-inside-avoid">
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">üì¶ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Top 10)</h3>
                                <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.materialData.slice(0,10)} layout="vertical" margin={{ left: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                                        <Tooltip />
                                        <Bar dataKey="value" fill="#10b981" radius={[0,4,4,0]} barSize={20} label={{ position: 'right', fontSize: 11 }} />
                                    </BarChart>
                                </ResponsiveContainer></div>
                            </div>
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">‚öôÔ∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (Top 10)</h3>
                                <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.processData.slice(0,10)} layout="vertical" margin={{ left: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                                        <Tooltip />
                                        <Bar dataKey="value" fill="#6366f1" radius={[0,4,4,0]} barSize={20} label={{ position: 'right', fontSize: 11 }} />
                                    </BarChart>
                                </ResponsiveContainer></div>
                            </div>
                        </div>

                        {/* Pie & Staff */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print-grid break-inside-avoid">
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">üç∞ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                                <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={stats.categoryData} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} innerRadius={40} paddingAngle={2} label={({ percent }) => percent > 0 ? `${(percent * 100).toFixed(0)}%` : null} labelLine={true} style={{ fontSize: '11px' }}>
                                            {stats.categoryData.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                        </Pie>
                                        <Tooltip />
                                        <Legend layout="horizontal" verticalAlign="bottom" wrapperStyle={{fontSize: '11px', paddingTop: '10px'}} />
                                    </PieChart>
                                </ResponsiveContainer></div>
                            </div>
                            <div className="glass-card p-6">
                                <h3 className="text-lg font-bold text-slate-700 mb-4">üèÜ Top 10 ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h3>
                                <div style={{ height: 300 }}><ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.sourceData.slice(0,10)} layout="vertical" margin={{ left: 10 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 11}} />
                                        <Tooltip />
                                        <Bar dataKey="value" fill="#ef4444" radius={[0,4,4,0]} barSize={15} label={{ position: 'right', fontSize: 11 }} />
                                    </BarChart>
                                </ResponsiveContainer></div>
                            </div>
                        </div>

                        {/* Table */}
                        <div className="glass-card overflow-hidden no-print">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                                <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Records)</span>
                                <span className="text-xs text-gray-400">Total: {stats.tableData.length} records</span>
                            </div>
                            <div className="overflow-x-auto max-h-[400px]">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="bg-white sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Date/Time</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Material</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Process</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold">Source</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold w-1/3">Raw Report</th>
                                            <th className="px-6 py-3 bg-slate-50 text-slate-500 font-semibold text-center">Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 bg-white">
                                        {stats.tableData.map((item, idx) => {
                                            const summary = getRowSummary(item.report);
                                            if(!summary) return null;
                                            const isHl = searchQuery.trim() !== '';
                                            return (
                                                <tr key={idx} className={`${isHl ? 'bg-yellow-50' : 'hover:bg-blue-50'} transition`}>
                                                    <td className="px-6 py-3 whitespace-nowrap"><div className="font-medium text-slate-700">{item.date}</div><div className="text-xs text-blue-400">{item.time} ({item.week})</div></td>
                                                    <td className="px-6 py-3"><span className="px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">{item.material}</span></td>
                                                    <td className="px-6 py-3"><span className="px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">{item.process}</span></td>
                                                    <td className="px-6 py-3 text-blue-600 font-medium">{summary.display}</td>
                                                    <td className="px-6 py-3 text-xs text-slate-500">{item.report}</td>
                                                    <td className="px-6 py-3 text-center font-bold text-slate-800">{summary.totalCount}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
